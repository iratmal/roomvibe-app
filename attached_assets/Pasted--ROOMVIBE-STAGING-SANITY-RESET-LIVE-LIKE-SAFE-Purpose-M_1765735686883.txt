# üß† ROOMVIBE ‚Äî STAGING SANITY RESET (LIVE-LIKE, SAFE)

**Purpose:**
Make **staging.roomvibe.app** behave **identical to production** (same UX, same flows), **WITHOUT** touching or reverting any existing staging design, layout, or data.

The goal is to fix recurring functional issues ("Feature not available", broken upgrade buttons, pricing glitches) by correcting **environment configuration and feature gating** ‚Äî *not by redesigning or syncing with live*.

---

## üîí NON-NEGOTIABLE ‚Äî READ FIRST

These rules are absolute:

* ‚ùå **DO NOT** copy, merge, sync, or overwrite anything from **production** into **staging**
* ‚ùå **DO NOT** revert or delete any existing staging pages, components, layouts, copy, or design
* ‚ùå **DO NOT** redesign pricing cards, buttons, spacing, colors, or typography
* ‚ùå **DO NOT** reset, migrate, or modify database data
* ‚ùå **DO NOT** introduce "temporary" staging hacks or environment-specific UI behavior

üëâ **Staging is the source of truth.**
üëâ Only configuration + logic fixes are allowed.

---

## ‚úÖ WHAT IS ALLOWED

You may **ONLY**:

* Adjust **environment variables** for the **staging deployment**
* Fix **feature gating logic** that incorrectly blocks features (pricing / upgrade / checkout)
* Add **staging-only diagnostics** (no secrets)
* Make **minimal, targeted code changes** strictly required for the above

Everything that already exists on staging must remain **unchanged visually and structurally**.

---

## üéØ GOAL

* Remove all incorrect **"Feature not available"** states
* Ensure pricing & upgrade flows behave correctly
* Make staging **live-like**, with the **only differences** being:

  * Stripe in **TEST** mode
  * Analytics optional OFF
  * GDPR optional OFF

Same code paths. Same UX. Different ENV.

---

## 1Ô∏è‚É£ ENVIRONMENT VARIABLE ALIGNMENT

Ensure the following variables **exist and are used consistently**.

### REQUIRED (BOTH ENVIRONMENTS)

* `APP_ENV=staging | production`
* `STRIPE_MODE=test | live`
* `STRIPE_ENABLED=true | false`
* `PAYMENTS_ENABLED=true | false`
* `ENABLE_ANALYTICS=true | false`
* `ENABLE_GDPR=true | false`
* Cookie flags:

  * `COOKIE_SECURE=true`
  * `COOKIE_SAMESITE=none`
* Any pricing-related feature flags (e.g. `FEATURE_PRICING_ENABLED=true`)

### TARGET VALUES

#### ‚úÖ STAGING

```
APP_ENV=staging
STRIPE_MODE=test
PAYMENTS_ENABLED=true
STRIPE_ENABLED=true
ENABLE_ANALYTICS=false   # optional
ENABLE_GDPR=false        # optional
COOKIE_SECURE=true
COOKIE_SAMESITE=none
```

#### ‚úÖ PRODUCTION (REFERENCE ONLY ‚Äî DO NOT TOUCH)

```
APP_ENV=production
STRIPE_MODE=live
PAYMENTS_ENABLED=true
STRIPE_ENABLED=true
ENABLE_ANALYTICS=true
ENABLE_GDPR=true
COOKIE_SECURE=true
COOKIE_SAMESITE=none
```

‚ö†Ô∏è **Important:**

* Staging must allow full upgrade flows.
* The ONLY difference is Stripe is **TEST**.

---

## 2Ô∏è‚É£ FIX "FEATURE NOT AVAILABLE" ‚Äî GLOBAL BANNER RULE

**Never show a global "Feature not available" banner on page load.**

### Required behavior

* Pricing page loads cleanly with plans and CTAs.
* Only on user action (click Upgrade) can a message appear.

If payments are intentionally disabled, show a clear message:

> "Payments are disabled in this environment."

---

## 3Ô∏è‚É£ STAGING-ONLY DIAGNOSTICS (MANDATORY)

Add safe, read-only visibility into staging configuration.

### API Endpoint (Preferred)

**Route:** `/api/health/env`

Return JSON (no secrets):

```json
{
  "appEnv": "staging",
  "stripeMode": "test",
  "paymentsEnabled": true,
  "stripeEnabled": true,
  "analyticsEnabled": false,
  "gdprEnabled": false,
  "version": "<git_sha_or_build_id>"
}
```

* Enabled on staging
* Production may return minimal or be disabled

Optional: small UI badge (staging only):

> `STAGING ¬∑ Stripe:test ¬∑ Payments:on ¬∑ v123`

---

## 4Ô∏è‚É£ AUTH & COOKIE CONSISTENCY

Ensure frontend requests behave identically across envs:

* `fetch(..., { credentials: 'include' })`
* or `axios({ withCredentials: true })`

No environment-specific auth logic allowed.

---

# üß® CRITICAL FIX (NEW) ‚Äî Payments click returns ‚ÄúFeature not available‚Äù + 503

## ‚úÖ Confirmed Symptoms

On staging, clicking **Activate Artist Plan** triggers:

* `POST /api/billing/create-checkout-session` ‚Üí status **503**
* Response body:

```json
{
  "error": "Feature not available",
  "message": "Payment processing is currently disabled.",
  "feature": "stripe"
}
```

Staging `/api/health/env` confirms:

* `PAYMENTS_ENABLED=true`
* `STRIPE_ENABLED=true`

‚û°Ô∏è This means backend boolean ENV checks are wrong.

---

## 5Ô∏è‚É£ REQUIRED BACKEND FIX ‚Äî Standardize ENV boolean parsing

### 5.1 Create a single helper (server-side) and use it everywhere

Create a helper file (name/location flexible), for example:

```ts
// envBool.ts
export function envBool(value: unknown): boolean {
  if (typeof value === 'boolean') return value;
  if (typeof value === 'string') {
    return ['true', '1', 'yes', 'on'].includes(value.toLowerCase());
  }
  return false;
}
```

### 5.2 Replace ALL direct env checks

‚ùå Remove patterns like:

```ts
if (!process.env.STRIPE_ENABLED) { ... }
if (process.env.STRIPE_ENABLED === 'true') { ... }
if (!process.env.PAYMENTS_ENABLED) { ... }
if (process.env.PAYMENTS_ENABLED === true) { ... }
```

‚úÖ Replace with:

```ts
import { envBool } from './envBool';

const stripeEnabled = envBool(process.env.STRIPE_ENABLED);
const paymentsEnabled = envBool(process.env.PAYMENTS_ENABLED);

const paymentsAvailable = stripeEnabled && paymentsEnabled;
```

---

## 6Ô∏è‚É£ Fix checkout endpoint gating + error codes

In `POST /api/billing/create-checkout-session`:

### 6.1 Correct gating

```ts
if (!paymentsAvailable) {
  return res.status(403).json({
    error: 'Payments disabled',
    message: 'Payments are disabled in this environment.',
    feature: 'stripe'
  });
}
```

### 6.2 Error code rules (IMPORTANT)

* Feature disabled (flag) ‚Üí **403**
* Missing config (keys/price IDs) ‚Üí **500** with clear message
* Stripe API failure ‚Üí **500** with safe message
* Success ‚Üí **200** with checkout URL/session

üö´ Do NOT return 503 for logical gating.
üö´ Do NOT use generic ‚ÄúFeature not available‚Äù for everything.

---

## 7Ô∏è‚É£ VALIDATION CHECKLIST (MUST TEST)

### Pricing & Upgrade

* `/pricing` loads with no global banner
* Clicking **Activate Artist Plan**:

  * returns **200**
  * redirects to **Stripe TEST** checkout

### Diagnostics

* `/api/health/env` returns correct values

### Core

* Login persists after refresh
* No console errors related to env flags

---

## 8Ô∏è‚É£ STOP CONDITIONS (ALL REQUIRED)

* Staging UI/design unchanged
* `/pricing` shows no "Feature not available" on load
* Clicking **Activate Artist Plan** redirects to Stripe **TEST** checkout
* Endpoint returns correct status codes (no 503 for gating)

---

## 9Ô∏è‚É£ AGENT DELIVERABLE

Provide:

1. List of files changed
2. Exact env vars required for staging (names only)
3. Evidence:

   * response from `/api/health/env`
   * successful checkout creation (status 200)
4. Short explanation:

   * What caused backend to think payments are disabled
   * What was changed to fix it

---

## ‚úÖ FINAL NOTE

This is a stabilization task. Do not over-engineer. Do not touch UI.

Once fixed, staging becomes trustworthy and future deploys become safe.
